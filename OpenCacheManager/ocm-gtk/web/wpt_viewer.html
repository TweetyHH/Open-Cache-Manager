<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <style type="text/css">
#map {
        width: 100%;
        height: 100%;
        border: 0px;
        padding: 0px;
        position: absolute;
     }
body {
        border: 0px;
        margin: 0px;
        padding: 0px;
        height: 100%;
     }
    </style>
    <script src="OpenLayers.js"></script>
    <script src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>
  <script src='http://maps.google.com/maps?file=api&amp;v=3'></script>



    <script type="text/javascript">
        <!--
        // complex map object
        var map;
 
	// Start position for the map (hardcoded here for simplicity,
	// but maybe you want to get from URL params)
	var lat = 45.39271;
	var lon = -75.63399;
	var zoom = 14;
	var pois,extra;
	var notify;
	var currentPopup;
	var gmap;
	var ghyb;
	var gphy;
	var osm;
	
	function getParm( name )
	{
	  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
	  var regexS = "[\\?&]"+name+"=([^&#]*)";
	  var regex = new RegExp( regexS );
	  var results = regex.exec( window.location.href );
	  if( results == null )
	    return "";
	  else
	    return results[1];
	}
 
    function init(){
        map = new OpenLayers.Map('map',
                { maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
                  numZoomLevels: 19,
                  maxResolution: 156543.0399,
                  units: 'm',
                  projection: new OpenLayers.Projection("EPSG:900913"),
                  displayProjection: new OpenLayers.Projection("EPSG:4326")
                });

        osm = new OpenLayers.Layer.OSM( "Open Street Map");

	    gmap = new OpenLayers.Layer.Google(
                    "Google Street Map",
                {'sphericalMercator': true}
	    );

	    ghyb = new OpenLayers.Layer.Google(
                "Google Hybrid",
                {'type': G_HYBRID_MAP, 'numZoomLevels':20, 'sphericalMercator': true}
            );

	    gphy = new OpenLayers.Layer.Google(
                "Google Terrain",
                {'type': G_PHYSICAL_MAP, 'sphericalMercator': true}
            );


            /*var yahoo = new OpenLayers.Layer.Yahoo(
                "Yahoo Street Map",
                {'sphericalMercator': true}
            );
            var yahoosat = new OpenLayers.Layer.Yahoo(
                "Yahoo Satellite",
                {'type': YAHOO_MAP_SAT, 'sphericalMercator': true}
            );
            var yahoohyb = new OpenLayers.Layer.Yahoo(
                "Yahoo Hybrid",
                {'type': YAHOO_MAP_HYB, 'sphericalMercator': true}
            );*/


	    extra = new OpenLayers.Layer.Markers("Other Geocaches");
        map.addLayers([osm, ghyb,gmap,gphy, extra]);
        map.addControl(new OpenLayers.Control.ScaleLine(),new OpenLayers.Pixel(80,10))
        map.addControl(new OpenLayers.Control.LayerSwitcher());
        
        var currmap = getParm('map');
        if (currmap == "osm")
        {
        	map.setBaseLayer(osm);
        }
        else if (currmap == "ghyb")
        {
       		map.setBaseLayer(ghyb);
        }
        else if (currmap == "gmap")
        {
        	map.setBaseLayer(gmap);
        }
        else if (currmap == "gphy")
        {
        	map.setBaseLayer(gphy);
        }

        var lonLat = new OpenLayers.LonLat(lon, lat).transform(map.displayProjection,  map.projection);
        if (!map.getCenter()) map.setCenter (lonLat, zoom);
        clearMarkers();
        map.events.register('moveend', null, mapMoved)
    }
        
    function clearMarkers()
    {
    	if (pois)	    
			pois.destroy();  
		if (notify)	    
			notify.destroy();
    	pois = new OpenLayers.Layer.Markers( "Waypoints" );
    	map.addLayer(pois);
    }

	function addMarker(lat, lon, icon, wptName, wptFullName, wptDescription, mode)
	{
		var size = new OpenLayers.Size(24,24);
		var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
		var icon = new OpenLayers.Icon(icon,size,offset);
		var lonlat = new OpenLayers.LonLat(lon, lat).transform(map.displayProjection,  map.projection);
		var feature = new OpenLayers.Feature(pois, lonlat);
		
		var openspan = "<span style='font-face:sans-serif; font-weight:bolder; font-size:12pt;";
		if (mode == "archived")
			openspan += " color:darkred; text-decoration:line-through;'>";
		else if (mode == "disabled")
			openspan += " color:darkred;'>";
		else if (mode == "checknotes")
			openspan += " color:darkorange;'>";
		else
			openspan += "'>";

		feature.popupClass = OpenLayers.Class(OpenLayers.Popup.FramedCloud, {'autoSize': true,  'maxSize': new OpenLayers.Size(300,300)});
		feature.data.popupContentHTML ="<div>" + openspan + wptName + "<br/>" + wptFullName + "</span><hr noshade>" + wptDescription;
		feature.data.icon = icon;
		var marker = feature.createMarker();
		marker.events.register('mousedown',feature,mousedown);
		pois.addMarker(marker);
	   	map.setCenter (lonlat, 14);
	}
	
	function addExtraMarker(lat, lon, icon, wptName, wptFullName, wptDescription, mode)
	{
		var size = new OpenLayers.Size(24,24);
		var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
		var icon = new OpenLayers.Icon(icon,size,offset);
		var lonlat = new OpenLayers.LonLat(lon, lat).transform(map.displayProjection,  map.projection);
		var feature = new OpenLayers.Feature(extra, lonlat);
		
		var openspan = "<span style='font-face:sans-serif; font-weight:bolder; font-size:12pt;";
		if (mode == "archived")
			openspan += " color:darkred; text-decoration:line-through;'>";
		else if (mode == "disabled")
			openspan += " color:darkred;'>";
		else if (mode == "checknotes")
			openspan += " color:darkorange;'>";
		else
			openspan += "'>";
		
		feature.popupClass = OpenLayers.Class(OpenLayers.Popup.FramedCloud, {'autoSize': true, 'minSize': new OpenLayers.Size(300,200), 'maxSize': new OpenLayers.Size(500,300)});
		feature.data.popupContentHTML ="<div>" + openspan + wptName + "<br/>" + wptFullName + "</span><hr noshade>" + wptDescription + "<hr noshade><a href='javascript:doSelectCache(\"" + wptName + "\")'>[Select this cache]</a></div>";
		feature.data.icon = icon;
		var marker = feature.createMarker();
		marker.setOpacity(0.66);
		map.raiseLayer(extra, -1)
		marker.events.register('mousedown',feature,mousedown);
		extra.addMarker(marker);
	}

	function mousedown(evt)
	{
	  		if (currentPopup != null)
	  		{
	  			currentPopup.hide();
	  		}
	  		
	  		if (this.popup == null) {
                    this.popup = this.createPopup(true);
                    map.addPopup(this.popup);
             }
             this.popup.show();
            currentPopup= this.popup;             
            OpenLayers.Event.stop(evt);
	}
	
	function goHome(lat, lon)
	{
		var lonLat = new OpenLayers.LonLat(lon, lat).transform(map.displayProjection,  map.projection);
		map.panTo(lonLat);
	}
	
	function doSelectCache(wpt)
	{
		currentPopup.hide();
		hidden.innerHTML = "<iframe src='ocm://select/" + wpt + "'/>";
	}


	function zoomToPoint(lat, lon)
	{
		var lonLat = new OpenLayers.LonLat(lon, lat).transform(map.displayProjection,  map.projection);	
		if (notify)	    
			notify.destroy();
		notify = new OpenLayers.Layer.Markers( "Notify" );
		var size = new OpenLayers.Size(48,48);
		var offset = new OpenLayers.Pixel(-(size.w/2), -(size.h/1.33));
		var icon = new OpenLayers.Icon("../icons/48x48/circle.png",size,offset);
		notify.addMarker(new OpenLayers.Marker(lonLat,icon));  	
		map.addLayer(notify);
		map.raiseLayer(notify, -1)
		map.panTo(lonLat);
	}
	
	function clearExtraMarkers()
	{
		if (extra != null)
			extra.destroy();
		extra = new OpenLayers.Layer.Markers("Other Geocaches");
		map.addLayer(extra);
	}
	
	function mapMoved(evt)
	{
		setTimeout('doMapMove()', 300);
	}
	
	function doMapMove()
	{
		var lonlat = map.getCenter().transform(map.projection, map.displayProjection);
		hidden.innerHTML = "<iframe src='ocm://mapmoved/" + lonlat.lat + "/" + lonlat.lon + "'/>";
	}
	
        // -->
    </script>
  </head>
  <body onload="init()">
    <div id="map"></div>
    <div id="hidden" style='visibility:hidden'/>
  </body>
</html>
